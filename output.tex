\let\ifpageguides=\iffalse
\let\ifoutputnotes=\iffalse
\newcount\diagnosis

\def\colorize#1#2{
  \pdfcolorstack0 push {#1 rg}
  #2
  \pdfcolorstack0 pop {}
}
\def\pagenote#1{\colorize{0 0 1}{#1}}
\def\pagewarning#1{\colorize{1 0 0}{#1} \message{#1}}

\def\hruleat#1{\kern#1 \hrule width \hsize height .2pt \kern-0.2pt \kern-#1 }

\def\pageguides{
  \dimen0=-\headskip \advance\dimen0 by \topskip
  \hruleat{\dimen0} % headline
  \hrule width \hsize \kern-0.4pt % top
  \hruleat\topskip % first baseline
  \dimen0=\textblockheight
  \hruleat{\dimen0} % last baseline
  \advance\dimen0 by \maxdepth
  \hruleat{\dimen0} % bottom
  \dimen0=\textblockheight \advance\dimen0 by \footskip
  \hruleat{\dimen0} % footline
}

\def\pageadjustmentnotes{
  \ifnum\adjustedpagesremaining>0
    \pagenote{(\the\textblockheightadjustment, \the\adjustedpagesremaining)}
  \fi
}

\def\pagenotes{
  \diagnosis=\outputpenalty
  \baselineskip=\leading
  \line{
    \runningheadtype \nv
    \pagenote{\the\vsize}
    \pageadjustmentnotes
    \hfil
    \ifnum\diagnosis=-10000
      \pagenote{new page}
    \else
      \ifnum\diagnosis=10000
        \pagenote{broke between paragraphs}
      \else
        \ifnum\diagnosis=1
          \pagenote{good paragraph break}
        \else
          \bodytype \bf\sc
          \divide\diagnosis by 2
          \ifodd\diagnosis \pagewarning{club} \fi
          \divide\diagnosis by 2
          \ifodd\diagnosis \pagewarning{hyphen} \fi
          \divide\diagnosis by 2
          \ifodd\diagnosis \pagewarning{widow} \fi
        \fi
      \fi
    \fi
  }
}

\def\page{\vbox{
  \ifpageguides \pageguides \fi
  \headline
  \textblock
  \footline
  \ifoutputnotes \pagenotes \fi
}}

\def\textblock{\box255 }

\def\headline{
  \vbox to 0pt{
    \kern-\headskip
    \line{\vbox to \topskip{}\runningheadtype \the\head}
    \vss
  }
  \nointerlineskip
}

\def\footline{
  \baselineskip=\footskip
    \advance\baselineskip by -\textblockheightadjustment
  \lineskiplimit=0pt
  \line{\runningheadtype\the\foot}
}

\def\rebuildpage{\unvbox255 \penalty\outputpenalty}

\def\shiponepage{
  \hoffset=\leftmargin
  \shipout\page
  \advancepageno
  \runningpageframes
  \setnexttextblocklength
}

\def\setnexttextblocklength{
  \ifcase\adjustedpagesremaining
    % Already using normal text blocks
  \or
    \normalpages
  \else
    \global\advance\adjustedpagesremaining by -1
  \fi
}

\def\adjustablepages{
  \ifdim\ht255=\vsize
    \shiponepage
  \else
    % \vsize at end of page differed from \vsize at start.
    % Rebuild using the ending \vsize
    \rebuildpage
  \fi
}

\output={\adjustablepages}
