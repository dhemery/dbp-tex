\let\ifpageguides=\iffalse
\let\ifoutputnotes=\iffalse
\newcount\diagnosis
\newcount\bestpass
\newcount\bestbreak
\newdimen\bestadjustment
\newtoks\breaknote

\def\hruleat#1{\kern#1 \hrule width \hsize height .2pt \kern-0.2pt \kern-#1 }

\def\pageguides{
  \dimen0=-\headskip \advance\dimen0 by \topskip
  \hruleat{\dimen0} % headline
  \hrule width \hsize \kern-0.4pt % top
  \hruleat\topskip % first baseline
  \dimen0=\vsize
  \hruleat{\dimen0} % last baseline
  \advance\dimen0 by \maxdepth
  \hruleat{\dimen0} % bottom
  \dimen0=\vsize \advance\dimen0 by \footskip
  \hruleat{\dimen0} % footline
}

\def\outputnotes{
  \diagnosis=\outputpenalty
  \baselineskip=\leading
  \line{
    \runningheadtype \nv
    (pass \the\deadcycles \the\breaknote, \the\vsize)
    \ifnum\diagnosis=-10000
      new page
    \else
      \ifnum\diagnosis=10000
        between paragraphs
      \else
        \ifnum\diagnosis=1
          paragraph
        \else
          \bodytype \bf\sc
          bad break
          \hfill
          \divide\diagnosis by 2
          \ifodd\diagnosis club \fi
          \divide\diagnosis by 2
          \ifodd\diagnosis hyphen \fi
          \divide\diagnosis by 2
          \ifodd\diagnosis widow \fi
        \fi
      \fi
    \fi
    \hfil
  }
}

\def\shiponepage{
  \hoffset=\leftmargin
  \shipout\page
  \userunningpageframe
  \advancepageno
}

\def\page{\vbox{
  \ifpageguides \pageguides \fi
  \headline
  \textblock
  \footline
  \ifoutputnotes \outputnotes \fi
}}

\def\textblock{
  \vbox to \vsize{
    \boxmaxdepth=\maxdepth
    \unvbox255
  }
}

\def\facingpages{
  \shiponepage
}

\def\rememberpagebreak{
  \global\bestpass=\deadcycles
  \global\bestbreak=\diagnosis
  \global\bestadjustment=\vsize
  \global\advance\bestadjustment by -\textblockheight
}

\def\rememberbestpagebreak{
  \ifnum\diagnosis<\bestbreak
    \rememberpagebreak
  \fi
}

\def\tryagainwithtextblock#1{
  \global\vsize=\textblockheight
  \global\advance\vsize by #1
  \unvbox255
}

\def\balancedspreads{
  \diagnosis=\outputpenalty
  \ifnum\diagnosis<2 \diagnosis=0 \fi
  \ifnum\diagnosis=10000 \diagnosis=0 \fi
  \ifnum\diagnosis=0
    \shiponepage
    \global\vsize=\textblockheight
    \global\bestpass=0
  \else
    \message{bad break (\the\diagnosis, pass \the\deadcycles, \the\vsize)}
    \ifcase\deadcycles % 1: normal textblock failed
      \rememberpagebreak
      \tryagainwithtextblock{-\leading} % one line short
    \or % 2: short textblock failed
      \rememberbestpagebreak
      \tryagainwithtextblock{\leading} % one line long
    \or % 3: long textblock failed
      \rememberbestpagebreak
      \tryagainwithtextblock{\bestadjustment} % best one so far
    \or % 4: settling for least bad
      \message{shipping anyway (from pass \the\bestpass)}
      \breaknote={:\the\bestpass}
      \shiponepage
      \global\vsize=\textblockheight
      \breaknote={}
    \fi
  \fi
}
