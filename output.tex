\let\ifpageguides=\iffalse
\let\ifoutputnotes=\iffalse
\countdef\diagnosis=4

\def\hruleat#1{\kern#1 \hrule width \hsize height .2pt \kern-0.2pt \kern-#1 }

\def\pageguides{
  \dimen0=-\headskip \advance\dimen0 by \topskip
  \hruleat{\dimen0} % headline
  \hrule width \hsize \kern-0.4pt % top
  \hruleat\topskip % first baseline
  \dimen0=\textblockheight
  \hruleat{\dimen0} % last baseline
  \advance\dimen0 by \maxdepth
  \hruleat{\dimen0} % bottom
  \dimen0=\textblockheight \advance\dimen0 by \footskip
  \hruleat{\dimen0} % footline
}

\def\outputnotes{
  \global\diagnosis=\outputpenalty
  \baselineskip=\leading
  \line{
    \runningheadtype \nv
    \the\vsize
    \hfil
    \ifnum\diagnosis=-10000
      new page
    \else
      \ifnum\diagnosis=10000
        broke between paragraphs
      \else
        \ifnum\diagnosis=1
          good paragraph break
        \else
          \bodytype \bf\sc
          bad:
          \divide\diagnosis by 2
          \ifodd\diagnosis club \fi
          \divide\diagnosis by 2
          \ifodd\diagnosis hyphen \fi
          \divide\diagnosis by 2
          \ifodd\diagnosis widow \fi
        \fi
      \fi
    \fi
  }
}

\def\page{\vbox{
  \ifpageguides \pageguides \fi
  \headline
  \textblock
  \footline
  \ifoutputnotes \outputnotes \fi
}}

\def\textblock{\box255 }

\def\facingpages{
  \ifdim\ht255=\vsize
    \hoffset=\leftmargin
    \shipout\page
    \advancepageno
    \normaltextblock
    \userunningpageframe
  \else % \vsize was changed during the page. Break again using \vsize
    \unvbox255
    \penalty\outputpenalty
  \fi
}

\output={\facingpages}
