\newcount\maxfontshrink
\newcount\maxfontstretch
\newcount\fontexpandstep
\font\testfont=cmr10

\catcode`\@=11

\def\fonttag{\scheme W\fontweight S\fontslant V\fontvariant F\fontfigures E\fontencoding}
\def\fontspec{\fontfilename\optionalwithprefix{ at }{\fontsize}}
\def\fontfilename{%
  \typefaceftag%
  \optionalwithprefix{-}{\fontshapeftag}%
  -\fontfiguresftag%
  \optionalwithprefix{-}{\fontvariantftag}%
  -\fontencodingftag%
}
\def\fontshapeftag{\optionalwithdefault{\fontweightftag\fontslantftag\schemeftag}{\fontrgrmftag}}
\def\fontweightftag{\csname @\typeface @\fontweight @ftag\endcsname}
\def\fontslantftag{\csname @\typeface @\fontslant @ftag\endcsname}
\def\fontvariantftag{\csname\fontvariant variantftag\endcsname}
\def\fontfiguresftag{\csname\fontfigures figuresftag\endcsname}
\def\fontencodingftag{\csname\fontencoding encodingftag\endcsname}
\def\nvvariantftag{}
\def\scvariantftag{sc}
\def\ttvariantftag{titling}
\def\osfiguresftag{osf}
\def\tffiguresftag{tf}
\def\lffiguresftag{lf}
\def\tlfiguresftag{tlf}
\def\txencodingftag{t1}
\def\syencodingftag{ts1}

% #1: the typeface name
% #2: the tag that identifies the typeface in font file names
% #3: the tag (if any) that identifies the regular weight in the typeface's font file names
% #4: the tag that identifies italic slant in the typeface's font file names
% #5: the tag that identifies bold weight in the typeface's font file names
% #6: the tag (if any) that identifies regular roman book style in the typeface's font file names
\def\newtypeface#1#2#3#4#5#6{
  \expandafter\xdef\csname @#1@ftag\endcsname{#2}
  \expandafter\xdef\csname @#1@rg@ftag\endcsname{#3}
  \expandafter\xdef\csname @#1@it@ftag\endcsname{#4}
  \expandafter\xdef\csname @#1@bf@ftag\endcsname{#5}
  \expandafter\xdef\csname @#1@rgrm@ftag\endcsname{#6}
  \expandafter\xdef\csname @#1@rm@ftag\endcsname{}
}

% #1: the scheme name
% #2: the typeface to use for this scheme
% #3: the tag that identifies the scheme's optical size in font file names
% #4: the font size (empty to use the font file's default size)
\def\newscheme#1#2#3#4{
  \expandafter\xdef\csname @#1@typeface\endcsname{#2}
  \expandafter\xdef\csname @#1@ftag\endcsname{#3}
  \expandafter\xdef\csname @#1@size\endcsname{\the#4}
}

% #1: the style name
% #2: the scheme to use for this style
% #3: the style's default font weight
% #4: the style's default font slant
% #5: the style's default variant
% #6: the style's default figure style
\def\newstyle#1#2#3#4#5#6{ % #1: a name for this style
  \expandafter\xdef\csname @#1@scheme\endcsname{#2}
  \expandafter\gdef\csname#1\endcsname{%
    \edef\fontstyle{#1}%
    \withscheme{\csname @\fontstyle @scheme\endcsname}%
    \withfontweight{#3}%
    \withfontslant{#4}%
    \withfontvariant{#5}%
    \withfontfigures{#6}%
    \withfontencoding{tx}%
    \selectfont%
  }
}

\def\withscheme#1{%
  \edef\scheme{#1}%
  \edef\schemeftag{\csname @\scheme @ftag\endcsname}%
  \withfontsize{\csname @\scheme @size\endcsname}%
  \withtypeface{\csname @\scheme @typeface\endcsname}%
}

\def\withtypeface#1{
  \edef\typeface{#1}%
  \edef\typefaceftag{\csname @\typeface @ftag\endcsname}%
  \edef\fontrgftag{\csname @\typeface @rg@ftag\endcsname}%
  \edef\fontbfftag{\csname @\typeface @bf@ftag\endcsname}%
  \edef\fontitftag{\csname @\typeface @it@ftag\endcsname}%
  \edef\fontrgrmftag{\csname @\typeface @rgrm@ftag\endcsname}%
}

\def\withfontweight#1{\edef\fontweight{#1}}
\def\withfontslant#1{\edef\fontslant{#1}}
\def\withfontvariant#1{\edef\fontvariant{#1}}
\def\withfontfigures#1{\edef\fontfigures{#1}}
\def\withfontencoding#1{\edef\fontencoding{#1}}
\def\withfontsize#1{\edef\fontsize{#1}}

\def\loadfont#1{%
  \ifcsname#1\endcsname%
  \else%
    \message{Loading #1 \fontspec}%
    \global\expandafter\font\csname#1\endcsname=\fontspec %
    \makeexpandable{\csname#1\endcsname}%
  \fi%
}

\catcode`\@=12

\def\selectfont{%
  \xdef\selectedfonttag{\fonttag}%
  \loadfont{\selectedfonttag}%
  \csname\selectedfonttag\endcsname%
}

\def\rg{\withfontweight{rg}\selectfont}
\def\bf{\withfontweight{bf}\selectfont}
\def\rm{\withfontslant{rm}\selectfont}
\def\it{\withfontslant{it}\selectfont}
\def\nv{\withfontvariant{nm}\selectfont}
\def\sc{\withfontvariant{sc}\selectfont}
\def\tt{\withfontvariant{tt}\selectfont}
\def\os{\withfontfigures{os}\selectfont}
\def\tf{\withfontfigures{tf}\selectfont}
\def\lf{\withfontfigures{lf}\selectfont}
\def\tl{\withfontfigures{tl}\selectfont}
\def\tx{\withfontencoding{tx}\selectfont}
\def\sy{\withfontencoding{sy}\selectfont}

\def\makeexpandable#1{\pdffontexpand#1 \maxfontstretch \maxfontshrink \fontexpandstep autoexpand}

\pdfadjustspacing=2

% TODO: Determine reasonable protrusions and turn this on
\pdfprotrudechars=0

\maxfontshrink=30
\maxfontstretch=30
\fontexpandstep=5
