\newcount\maxfontshrink
\newcount\maxfontstretch
\newcount\fontexpandstep

\catcode`\@=11

\def\fonttag{\scheme W\fontweight S\fontslant V\fontvariant F\fontfigures E\fontencoding}
\def\fontspec{\fontfilename\optionalwithprefix{ at }{\fontsize}}
\def\fontfilename{%
  \typefaceftag%
  \optionalwithprefix{-}{\fontshapeftag}%
  -\fontfiguresftag%
  \optionalwithprefix{-}{\fontvariantftag}%
  -\fontencodingftag%
}
\def\fontshapeftag{\optionalwithdefault{\fontweightftag\fontslantftag\schemeftag}{\fontdefaultftag}}
\def\fontweightftag{\csname @\typeface @\fontweight @ftag\endcsname}
\def\fontslantftag{\csname @\typeface @\fontslant @ftag\endcsname}
\def\fontvariantftag{\csname\fontvariant variantftag\endcsname}
\def\fontfiguresftag{\csname\fontfigures figuresftag\endcsname}
\def\fontencodingftag{\csname\fontencoding encodingftag\endcsname}
\def\nvvariantftag{}
\def\scvariantftag{sc}
\def\ttvariantftag{titling}
\def\osfiguresftag{osf}
\def\tffiguresftag{tosf}
\def\lffiguresftag{lf}
\def\tlfiguresftag{tlf}
\def\txencodingftag{t1}
\def\syencodingftag{ts1}

% #1: typeface name
% #2: ftag to select the typeface
% #3: ftag (if any) to select the typeface's regular weight (rg)
% #4: ftag to select the typeface's italic slant (it)
% #5: ftag to select the typeface's bold weight (bf)
% #6: ftag (if any) to select the typeface's regular weight, roman slant (rg, rm)
\def\newtypeface#1#2#3#4#5#6{
  \expandafter\xdef\csname @#1@ftag\endcsname{#2}
  \expandafter\xdef\csname @#1@rg@ftag\endcsname{#3}
  \expandafter\xdef\csname @#1@it@ftag\endcsname{#4}
  \expandafter\xdef\csname @#1@bf@ftag\endcsname{#5}
  \expandafter\xdef\csname @#1@default@ftag\endcsname{#6}
  \expandafter\xdef\csname @#1@rm@ftag\endcsname{}
}

\def\withtypeface#1{%
  \edef\typeface{#1}%
  \edef\typefaceftag{\csname @\typeface @ftag\endcsname}%
  \edef\fontrgftag{\csname @\typeface @rg@ftag\endcsname}%
  \edef\fontbfftag{\csname @\typeface @bf@ftag\endcsname}%
  \edef\fontitftag{\csname @\typeface @it@ftag\endcsname}%
  \edef\fontdefaultftag{\csname @\typeface @default@ftag\endcsname}%
}

% #1: scheme name
% #2: name of the scheme's typeface
% #3: ftag (if any) to select the scheme's optical size
% #4: font size
\def\newscheme#1#2#3#4{
  \expandafter\xdef\csname @#1@typeface\endcsname{#2}
  \expandafter\xdef\csname @#1@ftag\endcsname{#3}
  \expandafter\xdef\csname @#1@size\endcsname{\the#4}
}

\def\withscheme#1{%
  \edef\scheme{#1}%
  \edef\schemeftag{\csname @\scheme @ftag\endcsname}%
  \withfontsize{\csname @\scheme @size\endcsname}%
  \withtypeface{\csname @\scheme @typeface\endcsname}%
}

% #1: type name
% #2: name of the type's scheme
% #3: default weight (rg or bf)
% #4: default slant (rm or it)
% #5: default variant (nv, sc, tt)
% #6: default figure style (ls, lf, tf, lt)
\def\newtype#1#2#3#4#5#6{
  \expandafter\xdef\csname @#1@scheme\endcsname{#2}
  \expandafter\gdef\csname#1type\endcsname{%
    \edef\type{#1}%
    \withscheme{\csname @\type @scheme\endcsname}%
    \withfontweight{#3}%
    \withfontslant{#4}%
    \withfontvariant{#5}%
    \withfontfigures{#6}%
    \withfontencoding{tx}%
    \selectfont%
  }
}

\def\withfontweight#1{\edef\fontweight{#1}}
\def\withfontslant#1{\edef\fontslant{#1}}
\def\withfontvariant#1{\edef\fontvariant{#1}}
\def\withfontfigures#1{\edef\fontfigures{#1}}
\def\withfontencoding#1{\edef\fontencoding{#1}}
\def\withfontsize#1{\edef\fontsize{#1}}

\def\loadfont#1{%
  \ifcsname#1\endcsname%
  \else%
    \edef\new@font@name{\csname#1\endcsname}%
    \global\expandafter\font\new@font@name=\fontspec%
    \on@font@load{typeface}{\new@font@name}%
    \on@font@load{scheme}{\new@font@name}%
    \on@font@load{type}{\new@font@name}%
  \fi%
}

\def\on@font@load#1#2{%
  \edef\@scope{\csname#1\endcsname}%
  \ifcsname on\@scope#1load\endcsname%
    \csname on\@scope#1load\endcsname{#2}%
  \fi%
}

\catcode`\@=12

\def\selectfont{%
  \xdef\selectedfonttag{\fonttag}%
  \loadfont{\selectedfonttag}%
  \csname\selectedfonttag\endcsname%
}

\def\rg{\withfontweight{rg}\selectfont}
\def\bf{\withfontweight{bf}\selectfont}
\def\rm{\withfontslant{rm}\selectfont}
\def\it{\withfontslant{it}\selectfont}
\def\nv{\withfontvariant{nv}\selectfont}
\def\sc{\withfontvariant{sc}\selectfont}
\def\tt{\withfontvariant{tt}\selectfont}
\def\os{\withfontfigures{os}\selectfont}
\def\tf{\withfontfigures{tf}\selectfont}
\def\lf{\withfontfigures{lf}\selectfont}
\def\tl{\withfontfigures{tl}\selectfont}
\def\tx{\withfontencoding{tx}\selectfont}
\def\sy{\withfontencoding{sy}\selectfont}

\def\expandtextfont#1{\pdffontexpand#1 \maxfontstretch \maxfontshrink \fontexpandstep autoexpand}

\pdfadjustspacing=2
\pdfprotrudechars=0 % May not need this. It seems rare in novels.

\maxfontshrink=30
\maxfontstretch=30
\fontexpandstep=5
