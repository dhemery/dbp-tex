% How much of the horizontal margin space to allocate to
% the spine margin (thousandths)
\newcount\spinemarginratio

% How much of the vertical margin space to allocate to the
% top margin (thousandths)
\newcount\topmarginratio

% How many lines of text to put in each text block.
\newcount\textblocklines

\newdimen\spinemargin
\newdimen\edgemargin
\newdimen\textblockheight
\newdimen\textblockheightadjustment
\newcount\adjustedpagesremaining

\def\leftmargin{\ifodd\pageno \spinemargin\else\edgemargin\fi}

% Adjust the textblock to fit the current values of:
% - \pdfpagewidth
% - \hsize
% - \spinemargin
% - \textblocklines
% - \leading
% - \bodytextsize
\def\fittextblock{
  \dimen0=\dimexpr \pdfpagewidth - \hsize \relax % total horizontal margin space
  \global\spinemargin=\dimexpr \dimen0 * \spinemarginratio / 1000 \relax
  \global\edgemargin=\dimexpr \dimen0 - \spinemargin \relax
  \global\topskip=\bodytextsize
  \global\splittopskip=\topskip
  \global\maxdepth=\dimexpr \leading - \bodytextsize \relax
  \global\splitmaxdepth=\maxdepth
  \global\textblockheight=\dimexpr \textblocklines\leading - \maxdepth \relax
  \adjusttextblockheight{0pt}{0}
  \dimen0=\dimexpr \pdfpageheight - \textblockheight \relax % total vertical margin space
  \global\voffset=\dimexpr \dimen0 * \topmarginratio / 1000 \relax
}

\def\showtextblock{
  \message{\string\vsize: \the\vsize}
  \message{\string\hsize: \the\hsize}
  \message{\string\voffset: \the\voffset}
  \message{\string\spinemargin: \the\spinemargin}
  \message{\string\edgemargin: \the\edgemargin}
  \message{\string\textblockheight: \the\textblockheight}
  \message{\string\topskip: \the\topskip}
  \message{\string\maxdepth: \the\maxdepth}
  \message{\string\textblocklines: \the\textblocklines}
  \message{\string\spinemarginratio: \the\spinemarginratio}
  \message{\string\topmarginratio: \the\topmarginratio}
}

\def\adjusttextblockheight#1#2{
  \global\textblockheightadjustment=#1
  \global\vsize=\dimexpr \textblockheight + \textblockheightadjustment \relax
  \global\adjustedpagesremaining=#2
}

\spinemarginratio=618 % golden ratio
\topmarginratio=382 % 1 - golden ratio
