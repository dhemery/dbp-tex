% The margin at the spine of each page.
% After setting this, call \fittextblock
\newdimen\spinemargin

% The margin at the outer edge of each page.
% This is set by \fittextblock
\newdimen\edgemargin

% The number of lines of text in each textblock
\newcount\textblocklines
\newdimen\textblockheight

\def\leftmargin{\ifodd\pageno \spinemargin\else\edgemargin\fi}

% Adjust the textblock to fit the current values of:
% - \pdfpagewidth
% - \hsize
% - \spinemargin
% - \textblocklines
% - \leading
% - \textsize
\def\fittextblock{
  \edgemargin=\pdfpagewidth
    \advance\edgemargin by -\hsize
    \advance\edgemargin by -\spinemargin
  \topskip=\textsize
  \splittopskip=\topskip
  \maxdepth=\leading
    \advance\maxdepth by -\textsize
  \splitmaxdepth=\maxdepth
  \textblockheight=\textblocklines\leading
    \advance\textblockheight by -\maxdepth
  \normaltextblock
}

\def\showtextblock{
  \message{\string\voffset: \the\voffset}
  \message{\string\spinemargin: \the\spinemargin}
  \message{\string\edgemargin: \the\edgemargin}
  \message{\string\textblocklines: \the\textblocklines}
  \message{\string\textblockheight: \the\textblockheight}
  \message{\string\maxdepth: \the\maxdepth}
  \message{\string\topskip: \the\topskip}
  \message{\string\hsize: \the\hsize}
  \message{\string\vsize: \the\vsize}
}

\def\normaltextblock{\adjusttextblockheight{0pt}}
\def\runthispagelong{\adjusttextblockheight{\leading}}
\def\runthispageshort{\adjusttextblockheight{-\leading}}

\def\adjusttextblockheight#1{
  \global\vsize=\textblockheight
    \global\advance\vsize by #1
}
